services:
  # Frontend Static Site
  - type: web
    name: frontend
    env: static
    staticPublishPath: ./frontend/out
    buildCommand: |
      cd frontend
      npm install
      npm run build
    routes:
      - type: rewrite
        source: /.*
        destination: /index.html

  # Backend API Service
  - type: web
    name: backend-api
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheckPath: /
    envVars:
      - key: CONTAINER_ROLE
        value: api
      - key: DATABASE_URL_USER
        sync: false
      - key: DATABASE_URL_GENERAL
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
    
  # Backend Data Poller Worker
  - type: worker
    name: data-poller
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    envVars:
      - key: CONTAINER_ROLE
        value: data-poller
      - key: DATABASE_URL_USER
        fromDatabase:
          name: user-db
          property: connectionString
      - key: DATABASE_URL_GENERAL
        fromDatabase:
          name: general-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString

  # Backend Trading Engine Worker
  - type: worker
    name: trading-engine
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    envVars:
      - key: CONTAINER_ROLE
        value: trading-engine
      - key: DATABASE_URL_USER
        fromDatabase:
          name: user-db
          property: connectionString
      - key: DATABASE_URL_GENERAL
        fromDatabase:
          name: general-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString

  # Redis instance for caching and tasks
  - type: redis
    name: redis
    ipAllowList: [] # Allow all 

databases:
  - name: user-db
    databaseName: userdb
    user: btcuser
  - name: general-db
    databaseName: generaldb
    user: btcuser 